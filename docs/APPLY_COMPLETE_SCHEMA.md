# Apply Complete Database Schema to Cloud SQL

## Overview

Instead of creating tables one by one as errors occur, you can apply the complete database schema at once. This script creates all tables, enums, indexes, and foreign keys from your Prisma schema.

## Files

1. **`scripts/complete-schema.sql`** - Generated by Prisma, contains all CREATE statements
2. **`scripts/apply-complete-schema-safe.sql`** - Wrapper script with permission grants

## Important Notes

⚠️ **Warning**: The Prisma-generated SQL will fail if objects already exist. However, this is okay - the script will create missing objects and skip existing ones.

If you want a truly idempotent script, you'll need to manually wrap CREATE statements in DO blocks, or run the script and ignore errors for objects that already exist.

## Option 1: Run Complete Schema (Recommended)

### Steps

1. **Open Cloud SQL Studio:**
   - Go to: https://console.cloud.google.com/sql/instances/startege-db/databases?project=startege
   - Click on database: `startege`
   - Click "Open Cloud SQL Studio"

2. **Run the complete schema:**
   - Copy the contents of `scripts/complete-schema.sql`
   - Paste into SQL editor
   - Click "Run"
   - **Note**: You may see errors for objects that already exist - this is normal. The script will create missing objects.

3. **Grant permissions:**
   After running the schema, run this to grant permissions:
   ```sql
   -- Grant permissions to postgres user
   DO $$
   DECLARE
       r RECORD;
   BEGIN
       FOR r IN 
           SELECT tablename FROM pg_tables WHERE schemaname = 'public'
       LOOP
           BEGIN
               EXECUTE format('GRANT ALL PRIVILEGES ON TABLE %I TO postgres', r.tablename);
           EXCEPTION WHEN OTHERS THEN
               NULL;
           END;
       END LOOP;
   END $$;
   
   ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO postgres;
   ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO postgres;
   ```

## Option 2: Use Prisma Migrate (Alternative)

If you prefer using Prisma's migration system:

```bash
# Set DATABASE_URL to Cloud SQL
export DATABASE_URL="postgresql://postgres:Zoya%4057Bruce@localhost/startege?host=/cloudsql/startege:us-central1:startege-db"

# Use Cloud SQL Proxy (if running locally)
cloud-sql-proxy startege:us-central1:startege-db

# Then run:
npx prisma migrate deploy
```

Or use `prisma db push`:

```bash
npx prisma db push
```

## What Gets Created

The script creates:

### Enums (13 types)
- SuperLevelGroup
- ExamType
- ExamStatus
- ProgressStatus
- AttemptStatus
- CoverageType
- PersonaType
- KnowledgeLevel
- OnboardingStatus
- SourceType
- ScanType
- ScanStatus
- CreditTransactionType

### Tables (40+ tables)
All tables from your Prisma schema including:
- User, Account, Session, VerificationToken
- Domain, Category, ConceptCard
- UserProgress, UserPoints, Badge, UserBadge, UserStreak
- Challenge, ChallengeAttempt, ChallengeQuestion, ChallengeAnswer
- Exam, ExamAttempt
- AIGPExam, AIGPQuestion, AIGPExamAttempt, AIGPExamAnswer
- UserCategoryProgress, UserLevelProgress
- RemediationSession
- Subscription, Payment
- UserProfile, UserInterest, UserGoal, UserSettings
- OnboardingScenario, OnboardingScenarioAnswer
- PromptTemplate, PromptUsage, AgentConversation
- MarketScanArticle, ArticleCitation, ArticleRelation, ScanJob
- AICredit, CreditTransaction
- And more...

### Indexes and Foreign Keys
All indexes and foreign key constraints as defined in your Prisma schema.

## Verification

After running the script, verify tables exist:

```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;
```

You should see all tables from your Prisma schema.

## Troubleshooting

### Error: "relation already exists"
- This is normal if tables already exist
- The script will continue and create missing objects
- You can safely ignore these errors

### Error: "type already exists"
- This is normal if enums already exist
- The script will continue

### Error: "permission denied"
- Make sure you're connected as the `postgres` user
- Run the permission grant script after creating tables

## Regenerating the Schema

If you update your Prisma schema, regenerate the SQL:

```bash
npx prisma migrate diff --from-empty --to-schema-datamodel prisma/schema.prisma --script > scripts/complete-schema.sql
```

